#!/usr/bin/env bash
set -euo pipefail

brew_bin="$(command -v brew || true)"
if [ -z "$brew_bin" ]; then
  if [ -x "/opt/homebrew/bin/brew" ]; then
    brew_bin="/opt/homebrew/bin/brew"
  elif [ -x "/usr/local/bin/brew" ]; then
    brew_bin="/usr/local/bin/brew"
  else
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    brew_bin="$(command -v brew || true)"
    if [ -z "$brew_bin" ]; then
      if [ -x "/opt/homebrew/bin/brew" ]; then
        brew_bin="/opt/homebrew/bin/brew"
      elif [ -x "/usr/local/bin/brew" ]; then
        brew_bin="/usr/local/bin/brew"
      fi
    fi
    if [ -z "$brew_bin" ]; then
      echo "Homebrew install failed."
      exit 1
    fi
  fi
fi

source_dir="${CHEZMOI_SOURCE_DIR:-}"
if [ -z "$source_dir" ] && [ -f "$HOME/.config/chezmoi/chezmoi.toml" ]; then
  source_dir="$(awk -F '=' '/^sourceDir/{gsub(/[ \t\"]+/, "", $2); print $2; exit}' "$HOME/.config/chezmoi/chezmoi.toml")"
fi

if [ -z "$source_dir" ]; then
  echo "CHEZMOI_SOURCE_DIR not set and sourceDir not found."
  exit 1
fi

"$brew_bin" bundle --file "$source_dir/Brewfile"

brew_prefix="$($brew_bin --prefix)"
nvim_bin="$brew_prefix/bin/nvim"

if [ -x "$nvim_bin" ]; then
  "$nvim_bin" --headless "+Lazy! sync" +qa
elif command -v nvim >/dev/null 2>&1; then
  nvim --headless "+Lazy! sync" +qa
fi

# Brewfile snapshot for chezmoi change detection:
{{- include "Brewfile" | comment "# " -}}
