#!/usr/bin/env bash
set -euo pipefail

if ! command -v apt-get >/dev/null 2>&1; then
  exit 0
fi

source_dir="${CHEZMOI_SOURCE_DIR:-}"
if [ -z "$source_dir" ] && [ -f "$HOME/.config/chezmoi/chezmoi.toml" ]; then
  source_dir="$(awk -F '=' '/^sourceDir/{gsub(/[ \t\"]+/, "", $2); print $2; exit}' "$HOME/.config/chezmoi/chezmoi.toml")"
fi

if [ -z "$source_dir" ]; then
  echo "CHEZMOI_SOURCE_DIR not set and sourceDir not found."
  exit 1
fi

package_file="$source_dir/linux/apt-packages.txt"

if [ -f "$package_file" ]; then
  sudo apt-get update
  xargs -a "$package_file" sudo apt-get install -y
fi

if command -v nvim >/dev/null 2>&1; then
  nvim --headless "+Lazy! sync" +qa
fi

# apt-packages snapshot for chezmoi change detection:
{{- include "linux/apt-packages.txt" | comment "# " -}}
